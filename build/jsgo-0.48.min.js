/*
 JS-GO! Javascript Generic Objects
 License: GPLv3 (GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007)
          http://www.gnu.org/licenses/gpl-3.0.html

 Version: 0.48
 Last build: 2013-07-10 20:40
 Author:  Rubens Pinheiro GonÃ§alves Cavalcante
 Email:   rubenspgcavalcante@gmail.com
*/
JSGO={};Object.defineProperty(JSGO,"OPERATOR",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO,"METHOD",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO,"ORDER",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO,"FILTER",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO.OPERATOR,"TAUTOLOGICAL",{enumerable:!0,configurable:!1,writable:!1,value:"taut"});
Object.defineProperty(JSGO.OPERATOR,"CONTRADICTORY",{enumerable:!0,configurable:!1,writable:!1,value:"contr"});Object.defineProperty(JSGO.OPERATOR,"EQ",{enumerable:!0,configurable:!1,writable:!1,value:"eq"});Object.defineProperty(JSGO.OPERATOR,"NEQ",{enumerable:!0,configurable:!1,writable:!1,value:"neq"});Object.defineProperty(JSGO.OPERATOR,"GT",{enumerable:!0,configurable:!1,writable:!1,value:"gt"});Object.defineProperty(JSGO.OPERATOR,"GTE",{enumerable:!0,configurable:!1,writable:!1,value:"gte"});
Object.defineProperty(JSGO.OPERATOR,"MT",{enumerable:!0,configurable:!1,writable:!1,value:"mt"});Object.defineProperty(JSGO.OPERATOR,"MTE",{enumerable:!0,configurable:!1,writable:!1,value:"mte"});Object.defineProperty(JSGO.OPERATOR,"LIKE",{enumerable:!0,configurable:!1,writable:!1,value:"like"});Object.defineProperty(JSGO.OPERATOR,"HAS",{enumerable:!0,configurable:!1,writable:!1,value:"has"});Object.defineProperty(JSGO.METHOD,"SELECT",{enumerable:!0,configurable:!1,writable:!1,value:"SELECT"});
Object.defineProperty(JSGO.METHOD,"UPDATE",{enumerable:!0,configurable:!1,writable:!1,value:"UPDATE"});Object.defineProperty(JSGO.METHOD,"DELETE",{enumerable:!0,configurable:!1,writable:!1,value:"DELETE"});Object.defineProperty(JSGO.ORDER,"ASC",{enumerable:!0,configurable:!1,writable:!1,value:"asc"});Object.defineProperty(JSGO.ORDER,"DESC",{enumerable:!0,configurable:!1,writable:!1,value:"desc"});Object.defineProperty(JSGO.FILTER,"ALL",{enumerable:!0,configurable:!1,writable:!1,value:"filter-all"});
GenericObject=function GenericObject(b,c,d){if(b.constructor!=String)throw TypeError("className must be String");var f=0,e={},k={},h={},g={},l={};this.header={};var m={};for(i in c){c[i].type="undefined"==typeof c[i].type?"typeless":c[i].type;try{GenericObject.validateAttribute(c[i])}catch(n){return console.error(n),null}var p=c[i].name.replace(/\ |\./g,"_");m[p]={type:c[i].type,notNull:c[i].notNull,useCast:c[i].useCast,objectConstructor:c[i].objectConstructor}}Object.defineProperty(this.header,"format",
{value:m,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(this.header,"className",{value:b,writable:!1,enumerable:!0,configurable:!1});this.size=function(){return f};for(i in c)b=c[i].name.replace(/\ |\./g,"_"),this[b]={name:b,value:null},f++,e[b]=void 0==c[i].type?"undefined":c[i].type,g[b]="number"==typeof c[i].maxSize?c[i].maxSize:null,k[b]=!0==c[i].notNull?!0:!1,h[b]=!0==c[i].useCast?!0:!1,l[b]=void 0==c[i].objectConstructor?null:c[i].objectConstructor,this[b].validate=function(b){var c=
this.name,d=GenericObject.typesLibrary[e[c]];if((null==b||""==b)&&k[c])return{valid:!1,error:TypeError(c+" can't be null")};if("undefined"!=typeof b.length&&null!=g[c]){if(b.length>g[c])return{valid:!1,error:TypeError(c+" overflowed maximun size of "+g[c])}}else if("undefined"!=typeof d&&!d.validate(b))return{valid:!1,error:TypeError(c+" must be a "+e[c])};return{valid:!0,error:null}},this[b].cast=function(b,c){var d=GenericObject.typesLibrary[e[this.name]];return"undefined"!=typeof d.cast?d.cast(b,
c):b},this[b].set=function(b){h[this.name]&&(b=this.cast(b,l[this.name]));var c=this.validate(b);if(!c.valid)throw c.error;this.value=b},this[b].get=function(){return this.value},this[b].info=function(){return{type:e[this.name],notNull:k[this.name],useCast:h[this.name],maxSize:g[this.name]}};if("object"==typeof d){for(i in this)d[i]=this[i];return d}return this};GenericObject.prototype.each=function(a){var b=this.toObject();for(index in b)a(index,b[index])};GenericObject.prototype.toJson=function(){return JSON.stringify(this.toObject())};
GenericObject.prototype.toObject=function(){var a={},b=this.header.format;for(index in b)b=index,a[b]="undefined"==typeof this[b].value?null:this[b].value,null!=a[b]&&a[b].constructor==GenericObject&&(a[b]=a[b].toObject());return a};GenericObject.prototype.batchSet=function(a){for(i in a)if("function"!=typeof a[i]){if("undefined"==typeof this[i])throw Error("GenericObject "+this.header.className+" doesn't have the property "+i);this[i].set(a[i])}};
GenericObject.validateAttribute=function(a){if("string"!=typeof a.name)throw Error("key name must be a string");if("string"!=typeof a.type||"undefined"==typeof GenericObject.typesLibrary[a.type])throw Error(a.name+" attribute\n\t"+a.type+" is not a valid type. Look for valid types using GenericObject.types function");if("genericobject"==typeof a.type&&!(!0!=a.useCast||"function"==typeof a.objectConstructor&&new a.objectConstructor instanceof GenericObject))throw Error(a.name+" uses cast, please pass as parameter the objectConstructor of a GenericObject instance");
};
GenericObject.typesLibrary={typeless:{validate:function(a){return!0}},string:{validate:function(a){return"string"==typeof a},cast:function(a){return"object"==typeof a?a.toSource():String(a)}},number:{validate:function(a){return"number"==typeof a},cast:function(a){return Number(a)}},"boolean":{validate:function(a){return"boolean"==typeof a},cast:function(a){return Boolean(a)}},"function":{validate:function(a){return"function"==typeof a}},object:{validate:function(a){return"object"==typeof a}},array:{validate:function(a){return"object"==typeof a&&
a.constructor==Array}},genericobject:{validate:function(a){return a instanceof GenericObject},cast:function(a,b){if("object"==typeof a&&a.constructor==Object){if("undefined"==typeof b||null==b)throw Error("Must pass a constructor to cast the object to a genericobject");if(b()instanceof GenericObject){var c=new b;c.batchSet(a);return c}}throw GenericObject.typesLibrary.Error.ofCast(a,"genericobject");}},integer:{validate:function(a){return"number"==typeof a&&/^[+-]?[0-9]+$/.test(a)},cast:function(a){return Number(a)}},
positive:{validate:function(a){return"number"==typeof a&&0<=a},cast:function(a){return Math.abs(Number(a))}},negative:{validate:function(a){return"number"==typeof a&&0>=a},cast:function(a){a=Number(a);return 0>=a?a:-a}},date:{validate:function(a){return"object"==typeof a&&a.constructor==Date},cast:function(a){if("number"==typeof a)return new Date(a);if("Object"==typeof a)return new Date(a[0],a[1],a[2]);if("string"==typeof a){var b=new Date(a);if(b.isValid())return b}throw GenericObject.typesLibrary.Error.ofCast(a,
"date");}},year:{validate:function(a){return"number"==typeof a&&/^[0-9]{4}$/.test(a)},cast:function(a){"string"==typeof a?a=Number(a):"object"==typeof a&&a.constructor==Date&&(a=a.getFullYear());if(this.validate(a))return a;throw GenericObject.typesLibrary.Error.ofCast(a,"year");}},email:{validate:function(a){return/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(a)}},phone:{validate:function(a){return/^(\+[0-9]{2})?[0-9]{3}[0-9]*$/.test(a)}}};
GenericObject.typesLibrary.Error={ofCast:function(a,b){return Error("The value "+a+" can't be casted to a "+b)}};
GenericObject.newType=function(a,b,c){this.typesLibrary[a]={};if("undefined"==typeof a||null==a)throw TypeError("First parameter must contain a string representing the name of the type");if("function"!=typeof b||null==b)throw TypeError("The second parameter must contain a function");this.typesLibrary[a].validate=b;if("undefined"!=typeof c){if("function"!=typeof c)throw TypeError("The third parameter must contain a function");if("boolean"!=typeof b("test"))throw Error("The validation function must return boolean");
this.typesLibrary[a].cast=c}};GenericObject.types=function(){var a=[];for(i in types=this.typesLibrary)a.push(i);return a};GenericObjectCollection=function(){this.objects=[]};GenericObjectCollection.prototype.add=function(a){var b=arguments;for(i in b)if("undefined"!=typeof b[i].length)for(j in b[i])b[i][j]instanceof GenericObject&&this.objects.push(b[i][j]);else b[i]instanceof GenericObject&&this.objects.push(b[i])};
GenericObjectCollection.prototype._find=function(a,b,c){var d=[];for(index in this.objects)if("undefined"!=typeof this.objects[index][a]&&this.objects[index][a].get()==b){var f={index:index,object:this.objects[index]};if(c)return f;d.push(f)}return 0==d.length?null:d};GenericObjectCollection.prototype.find=function(a,b){var c=this._find(a,b,!1),d=[];for(i in c)d.push(c[i].object);return d};GenericObjectCollection.prototype.findUnique=function(a,b){var c=this._find(a,b,!0);return null==c?null:c.object};
GenericObjectCollection.prototype.indexesOf=function(a,b){var c=this._find(a,b,!1),d=[];for(i in c)d.push(c[i].index);return d};GenericObjectCollection.prototype.indexOf=function(a,b){var c=this._find(a,b,!0);return null!=c?c.index:-1};GenericObjectCollection.prototype.remove=function(a,b){var c=this._find(a,b,!0);return null!=c?(this.objects.splice(c.index,1),!0):!1};GenericObjectCollection.prototype.toObjects=function(){var a=[];for(i in this.objects)a.push(this.objects[i].toObject());return a};
GenericObjectCollection.prototype.sort=function(a,b){if("undefined"==typeof b||b!=JSGO.ORDER.ASC&&b!=JSGO.ORDER.DESC)throw Error("Order type unrecognized. Use JSGO.ORDER enumeration.");this.objects.sort(function(c,d){c=c[a].get();d=d[a].get();return c>d?b==JSGO.ORDER.ASC?1:-1:c<d?b==JSGO.ORDER.ASC?-1:1:0})};GenericObjectCollection.prototype.each=function(a){for(var b=!0,c=0;c<this.objects.length&&(b=a(c,this.objects[c]),!1!=b);c++);};
GenericObjectCollection.prototype.prettyPrint=function(a){var b="",c=this.toObjects();for(i in c){b+="index: "+i+" Class: "+this.objects[i].header.className+"\n";for(j in c[i])b+="\t"+j+": "+c[i][j]+"\n";b+="\n\n"}!0==a&&console.log(b);return b};
GenericObjectCollection.Query=function(a){var b=this;this.collection=a;this.lastQuery=null;this.query={type:null,selection:null,from:null,where:null,updateTo:[],orderby:null};this.fromFunc=function(a){var d={};b.query.from=a;d.Where=function(d){d==JSGO.FILTER.ALL&&(d=new GenericObjectCollection.Filter(null,JSGO.OPERATOR.TAUTOLOGICAL,null));d=d.toRoot();var e={};b.query.where={attribute:d.attribute,operator:d.operator,value:d.value};var k=function(){var e=!1;b.query.type==JSGO.METHOD.SELECT&&(e=[]);
var g=[],g=b.collection instanceof GenericObjectCollection?b.collection.objects.slice():b.collection.slice(),l=0;for(i in g)if("string"!=typeof a&&g instanceof a||"*"==a||g[i].header.className==a){if(d.process(g[i]))switch(b.query.type){case JSGO.METHOD.SELECT:e.push(b.selectedAttributes(g[i]));break;case JSGO.METHOD.UPDATE:var k=b.__whenUpdate(b.query.selection,i),e=e?!0:k;break;case JSGO.METHOD.DELETE:b.collection.objects.splice(l,1);l--;e=!0;break;default:throw Error("Query type doesn't exist. Use the JSGO.METHOD enum");
}l++}null!=b.orderby&&b.__whenOrderBy(e,b.orderby.attribute,b.orderby.order);return e};if(b.query.type==JSGO.METHOD.UPDATE)return e.Set=function(){var a={};b.query.updateTo=arguments;a.run=k;return a},e;b.query.type==JSGO.METHOD.SELECT&&(e.OrderBy=function(a,c){var d={};b.orderby={attribute:a,order:c};d.run=k;return d});e.run=k;return e};return d}};
GenericObjectCollection.Query.deepSearch=function(a,b){var c=a.indexOf("."),d=a.slice(0,c),f=null;a=a.slice(c+1);if("undefined"==typeof b[d])return null;f=b instanceof GenericObject?b[d].get():b[d];return-1!=a.indexOf(".")&&null!=f?GenericObjectCollection.Query.deepSearch(a,f):null!=f?f instanceof GenericObject?f[a].get():f[a]:null};
GenericObjectCollection.Filter=function(a,b,c,d){this.attribute=a;this.operator=b;this.value=c;this.parent="undefined"==typeof d?null:d;this.xor=this.and=this.or=null;return this};GenericObjectCollection.Filter.PreDefined=function(a,b,c){if(a==JSGO.FILTER.ALL)return GenericObjectCollection.Filter(b,JSGO.OPERATOR.LIKE,/\d*/)};GenericObjectCollection.Filter.prototype.empty=function(){return"undefined"==typeof this.attribute||"undefined"==typeof this.operator||"undefined"==typeof this.value};
GenericObjectCollection.Filter.prototype.init=function(a,b,c){this.attribute=a;this.operator=b;this.value=c;return this};GenericObjectCollection.Filter.prototype.OR=function(a,b,c){this.or=new GenericObjectCollection.Filter(a,b,c,this);this.xor=this.and=null;return this.or};GenericObjectCollection.Filter.prototype.AND=function(a,b,c){this.and=new GenericObjectCollection.Filter(a,b,c,this);this.xor=this.or=null;return this.and};
GenericObjectCollection.Filter.prototype.XOR=function(a,b,c){this.xor=new GenericObjectCollection.Filter(a,b,c,this);this.or=this.and=null;return this.xor};GenericObjectCollection.Filter.prototype.toRoot=function(){for(var a=this;null!=a.parent;)a=a.parent;return a};
GenericObjectCollection.Filter.prototype.process=function(a){var b=!1,c=null;if(this.operator==JSGO.OPERATOR.TAUTOLOGICAL)return!0;if(this.operator==JSGO.OPERATOR.CONTRADICTORY)return!1;if(-1!=this.attribute.indexOf("."))c=GenericObjectCollection.Query.deepSearch(this.attribute,a);else if(a instanceof GenericObject)if("undefined"!=typeof a[this.attribute])c=a[this.attribute].get();else throw Error(this.attribute+" is not a attribute of "+a.header.className);else c=a[this.attribute];switch(this.operator){case JSGO.OPERATOR.EQ:c==
this.value&&(b=!0);break;case JSGO.OPERATOR.NEQ:c!=this.value&&(b=!0);break;case JSGO.OPERATOR.GTE:c>=this.value&&(b=!0);break;case JSGO.OPERATOR.MTE:c<=this.value&&(b=!0);break;case JSGO.OPERATOR.GT:c>this.value&&(b=!0);break;case JSGO.OPERATOR.MT:c<this.value&&(b=!0);break;case JSGO.OPERATOR.LIKE:this.value instanceof RegExp&&this.value.test(c)&&(b=!0);break;case JSGO.OPERATOR.HAS:if(c instanceof Array)for(var d in c)if(this.value==c[d]){b=!0;break}break;default:throw Error("Operator "+this.operator+
" doesn't exists");}if(1<(null!=this.or)+(null!=this.and)+(null!=this.xor))throw Error("Filter using more than one logic conector.");return null!=this.or?b||this.or.process(a):null!=this.and?b&&this.and.process(a):null!=this.xor?(a=this.xor.process(a),b&&!a||!b&&a):b};
GenericObjectCollection.Query.prototype.Select=function(a){if(Array.isArray(a))this.query.selection=a;else{var b=arguments;this.query.selection=[];for(i in b)this.query.selection.push(b[i])}var c=this,b={};this.query.type=JSGO.METHOD.SELECT;b.From=this.fromFunc;this.selectedAttributes=function(a){var b={},e=c.query.selection;for(i in e){if("*"==e[i]){b=a instanceof GenericObject?a.toObject():a;break}"undefined"!=typeof e[i]?-1!=e[i].indexOf(".")?b[e[i]]=GenericObjectCollection.Query.deepSearch(e[i],
a):b[e[i]]=a[e[i]]instanceof GenericObject?a[e[i]].get():a[e[i]]:b[e[i]]=null}return b};return b};Object.defineProperty(GenericObjectCollection.Query.prototype,"__whenOrderBy",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b,c){if("undefined"==typeof c||c!=JSGO.ORDER.ASC&&c!=JSGO.ORDER.DESC)throw Error("Unrecognized order type. Use JSGO.ORDER enum");a.sort(function(a,f){a=a[b];f=f[b];return c==JSGO.ORDER.ASC?a>f:a<f})}});
GenericObjectCollection.Query.prototype.Update=function(a){if(Array.isArray(a))this.query.selection=a;else{var b=arguments;this.query.selection=[];for(i in b)this.query.selection.push(b[i])}b={};this.query.type=JSGO.METHOD.UPDATE;b.From=this.fromFunc;return b};
Object.defineProperty(GenericObjectCollection.Query.prototype,"__whenUpdate",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){var c=!1;for(attr in a)try{if(-1!=a[attr].indexOf(".")){var d=a[attr].split("."),f=this.collection.objects[b],e=0;for(e;e<d.length-1;e++)f=f instanceof GenericObject?f[d[e]].get():f[d[e]];f instanceof GenericObject?f[d[e]].set(this.query.updateTo[attr]):f[d[e]]=this.query.updateTo[attr]}this.collection.objects[b][a[attr]].set(this.query.updateTo[attr]);c=!0}catch(k){var h=
this.query.updateTo[attr],e=collection.objects[b][a[attr]].info().type,g=this.collection.objects[b],h="On UPDATE: Attribute "+a[attr]+" doesn't accepts "+h+" as a valid value\n",h=h+("\tCollection index: "+b+"\n"),h=h+("\tAttribute type: "+e+"\n"),h=h+"\tObject:\n";console.warn(h,g)}return c}});GenericObjectCollection.Query.prototype.Delete=function(a){this.query.selection=[];a={};this.query.type=JSGO.METHOD.DELETE;a.From=this.fromFunc;return a};