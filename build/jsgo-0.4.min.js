/*
 JS-GO! Javascript Generic Objects
 License: GPLv3 (GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007)
          http://www.gnu.org/licenses/gpl-3.0.html

 Version: 0.4
 Last build: 2013-02-06 21:52
 Author:  Rubens Pinheiro GonÃ§alves Cavalcante
 Email:   rubenspgcavalcante@gmail.com
*/
JSGO={};Object.defineProperty(JSGO,"OPERATOR",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO,"METHOD",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO,"ORDER",{enumerable:!0,configurable:!1,writable:!1,value:{}});Object.defineProperty(JSGO.OPERATOR,"EQ",{enumerable:!0,configurable:!1,writable:!1,value:"eq"});Object.defineProperty(JSGO.OPERATOR,"GT",{enumerable:!0,configurable:!1,writable:!1,value:"gt"});
Object.defineProperty(JSGO.OPERATOR,"GTE",{enumerable:!0,configurable:!1,writable:!1,value:"gte"});Object.defineProperty(JSGO.OPERATOR,"MT",{enumerable:!0,configurable:!1,writable:!1,value:"mt"});Object.defineProperty(JSGO.OPERATOR,"MTE",{enumerable:!0,configurable:!1,writable:!1,value:"mte"});Object.defineProperty(JSGO.OPERATOR,"LIKE",{enumerable:!0,configurable:!1,writable:!1,value:"like"});Object.defineProperty(JSGO.METHOD,"SELECT",{enumerable:!0,configurable:!1,writable:!1,value:"SELECT"});
Object.defineProperty(JSGO.METHOD,"UPDATE",{enumerable:!0,configurable:!1,writable:!1,value:"UPDATE"});Object.defineProperty(JSGO.METHOD,"DELETE",{enumerable:!0,configurable:!1,writable:!1,value:"DELETE"});Object.defineProperty(JSGO.ORDER,"ASC",{enumerable:!0,configurable:!1,writable:!1,value:"asc"});Object.defineProperty(JSGO.ORDER,"DESC",{enumerable:!0,configurable:!1,writable:!1,value:"desc"});
GenericObject=function GenericObject(b,c,d){var f=0,e={},k={},g={},h={},l={};this.header={};var m={};for(i in c){var n=c[i].name.replace(/\ |\./g,"_");m[n]={type:c[i].type,notNull:c[i].notNull,useCast:c[i].useCast,objectConstructor:c[i].objectConstructor}}Object.defineProperty(this.header,"format",{value:m,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(this.header,"GenericObject",{value:!0,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(this.header,"className",
{value:b,writable:!1,enumerable:!0,configurable:!1});this.size=function(){return f};for(i in c)b=c[i].name.replace(/\ |\./g,"_"),this[b]={name:b,value:null},f++,e[b]=void 0==c[i].type?"undefined":c[i].type,h[b]="number"==typeof c[i].maxSize?c[i].maxSize:null,k[b]=!0==c[i].notNull?!0:!1,g[b]=!0==c[i].useCast?!0:!1,l[b]=void 0==c[i].objectConstructor?null:c[i].objectConstructor,this[b].validate=function(b){var c=this.name,d=GenericObject.typesLibrary[e[c]];if((null==b||""==b)&&k[c])return{valid:!1,
error:TypeError(c+" can't be null")};if("undefined"!=typeof b.length&&null!=h[c]){if(b.length>h[c])return{valid:!1,error:TypeError(c+" overflowed maximun size of "+h[c])}}else if("undefined"!=typeof d&&!d.validate(b))return{valid:!1,error:TypeError(c+" must be a "+e[c])};return{valid:!0,error:null}},this[b].cast=function(b,c){var d=GenericObject.typesLibrary[e[this.name]];return"undefined"!=typeof d.cast?d.cast(b,c):b},this[b].set=function(b){g[this.name]&&(b=this.cast(b,l[this.name]));var c=this.validate(b);
if(!c.valid)throw c.error;this.value=b},this[b].get=function(){return this.value},this[b].info=function(){return{type:e[this.name],notNull:k[this.name],useCast:g[this.name],maxSize:h[this.name]}};if("object"==typeof d){for(i in this)d[i]=this[i];return d}return this};GenericObject.prototype.each=function(a){var b=this.toObject();for(index in b)a(index,b[index])};GenericObject.prototype.toJson=function(){return JSON.stringify(this.toObject())};
GenericObject.prototype.toObject=function(){var a={},b=this.header.format;for(index in b)b=index,a[b]="undefined"==typeof this[b].value?null:this[b].value;return a};GenericObject.prototype.batchSet=function(a){for(i in a)if("function"!=typeof a[i]){if("undefined"==typeof this[i])throw Error("GenericObject "+this.header.className+" doesn't have the property "+i);this[i].set(a[i])}};
GenericObject.typesLibrary={undefined:{validate:function(){return!0}},string:{validate:function(a){return"string"==typeof a},cast:function(a){return"object"==typeof a?a.toSource():String(a)}},number:{validate:function(a){return"number"==typeof a},cast:function(a){return Number(a)}},"boolean":{validate:function(a){return"boolean"==typeof a},cast:function(a){return Boolean(a)}},"function":{validate:function(a){return"function"==typeof a}},object:{validate:function(a){return"object"==typeof a}},array:{validate:function(a){return"object"==
typeof a&&"Array"==a.constructor.name}},genericobject:{validate:function(a){return a instanceof GenericObject},cast:function(a,b){if("object"==typeof a&&"Object"==a.constructor.name){if("undefined"==typeof b||null==b)throw Error("Must pass a constructor to cast the object to a genericobject");if(b()instanceof GenericObject){var c=new b;c.batchSet(a);return c}}throw GenericObject.typesLibrary.Error.ofCast(a,"genericobject");}},integer:{validate:function(a){return"number"==typeof a&&/^[+-]?[0-9]+$/.test(a)},
cast:function(a){return Number(a)}},positive:{validate:function(a){return"number"==typeof a&&0<=a},cast:function(a){return Math.abs(Number(a))}},negative:{validate:function(a){return"number"==typeof a&&0>=a},cast:function(a){a=Number(a);return 0>=a?a:-a}},date:{validate:function(a){return"object"==typeof a&&"Date"==a.constructor.name},cast:function(a){if("number"==typeof a)return new Date(a);if("Object"==typeof a)return new Date(a[0],a[1],a[2]);throw GenericObject.typesLibrary.Error.ofCast(a,"date");
}},year:{validate:function(a){return"number"==typeof a&&/^[0-9]{4}$/.test(a)},cast:function(a){"string"==typeof a?a=Number(a):"object"==typeof a&&"Date"==a.constructor.name&&(a=a.getFullYear());if(this.validate(a))return a;throw GenericObject.typesLibrary.Error.ofCast(a,"year");}},email:{validate:function(a){return/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(a)}},phone:{validate:function(a){return/^(\+[0-9]{2})?[0-9]{3}[0-9]*$/.test(a)}}};
GenericObject.typesLibrary.Error={ofCast:function(a,b){return Error("The value "+a+" can't be casted to a "+b)}};
GenericObject.newType=function(a,b,c){if("undefined"==typeof a||null==a)throw TypeError("First parameter must contain a string representing the name of the type");if("function"!=typeof b||null==b)throw TypeError("The second parameter must contain a function");if("undefined"!=typeof c&&"function"!=typeof c)throw TypeError("The third parameter must contain a function");if("boolean"!=typeof b("test"))throw Error("The validation function must return boolean");this.typesLibrary[a]={validate:b}};
GenericObject.types=function(){var a=[];for(i in types=this.typesLibrary)a.push(i);return a};GenericObjectCollection=function(){this.objects=[]};GenericObjectCollection.prototype.add=function(a){var b=arguments;for(i in b)if("undefined"!=typeof b[i].length)for(j in b[i])b[i][j]instanceof GenericObject&&this.objects.push(b[i][j]);else b[i]instanceof GenericObject&&this.objects.push(b[i])};
GenericObjectCollection.prototype._find=function(a,b,c){var d=[];for(index in this.objects)if("undefined"!=typeof this.objects[index][a]&&this.objects[index][a].get()==b){var f={index:index,object:this.objects[index]};if(c)return f;d.push(f)}return 0==d.length?null:d};GenericObjectCollection.prototype.find=function(a,b){var c=this._find(a,b,!1),d=[];for(i in c)d.push(c[i].object);return d};GenericObjectCollection.prototype.findUnique=function(a,b){var c=this._find(a,b,!0);return null==c?null:c.object};
GenericObjectCollection.prototype.indexesOf=function(a,b){var c=this._find(a,b,!1),d=[];for(i in c)d.push(c[i].index);return d};GenericObjectCollection.prototype.indexOf=function(a,b){var c=this._find(a,b,!0).index;return null!=c?c:-1};GenericObjectCollection.prototype.remove=function(a,b){var c=this._find(a,b,!0);return null!=c?(this.objects.splice(c.index,1),!0):!1};GenericObjectCollection.prototype.toObjects=function(){var a=[];for(i in this.objects)a.push(this.objects[i].toObject());return a};
GenericObjectCollection.prototype.sort=function(a,b){if("undefined"==typeof b||b!=JSGO.ORDER.ASC&&b!=JSGO.ORDER.DESC)throw Error("Order type unrecognized. Use JSGO.ORDER enumeration.");this.objects.sort(function(c,d){c=c[a].get();d=d[a].get();return b==JSGO.ORDER.ASC?c>d:c<d})};GenericObjectCollection.prototype.each=function(a){for(var b=0;b<this.objects.length;b++)a(b,this.objects[b])};
GenericObjectCollection.prototype.prettyPrint=function(a){var b="",c=this.toObjects();for(i in c){b+="index: "+i+" Class: "+this.objects[i].header.className+"\n";for(j in c[i])b+="\t"+j+": "+c[i][j]+"\n";b+="\n\n"}!0==a&&console.log(b);return b};
GenericObjectCollection.Query=function(a){var b=this;this.collection=a;this.lastQuery=null;this.query={type:null,selection:null,from:null,where:null,updateTo:[],orderby:null};this.fromFunc=function(a){var d={};b.query.from=a;d.Where=function(d){d=d.toRoot();var e={};b.query.where={attribute:d.attribute,operator:d.operator,value:d.value};var k=function(){var e=b.query.type==JSGO.METHOD.SELECT?[]:!1,h=b.collection.objects.slice(),l=0;for(i in h)if(h[i].header.className==a){if(d.process(h[i]))switch(b.query.type){case JSGO.METHOD.SELECT:e.push(b.selectedAttributes(h[i]));
break;case JSGO.METHOD.UPDATE:var k=b.__whenUpdate(b.query.selection,i),e=e?!0:k;break;case JSGO.METHOD.DELETE:b.collection.objects.splice(l,1);l--;e=!0;break;default:throw Error("Query type doesn't exist. Use the JSGO.METHOD enum");}l++}null!=b.orderby&&b.__whenOrderBy(e,b.orderby.attribute,b.orderby.order);return e};if(b.query.type==JSGO.METHOD.UPDATE)return e.Set=function(){var a={};b.query.updateTo=arguments;a.run=k;return a},e;b.query.type==JSGO.METHOD.SELECT&&(e.OrderBy=function(a,c){var d=
{};b.orderby={attribute:a,order:c};d.run=k;return d});e.run=k;return e};return d}};GenericObjectCollection.Query.deepSearch=function(a,b){var c=a.indexOf("."),d=a.slice(0,c),f=null;a=a.slice(c+1);if("undefined"==typeof b[d])return null;f=b instanceof GenericObject?b[d].get():b[d];return-1!=a.indexOf(".")&&null!=f?GenericObjectCollection.Query.deepSearch(a,f):null!=f?f instanceof GenericObject?f[a].get():f[a]:null};
GenericObjectCollection.Filter=function(a,b,c,d){this.attribute=a;this.operator=b;this.value=c;this.parent="undefined"==typeof d?null:d;this.xor=this.and=this.or=null;return this};GenericObjectCollection.Filter.prototype.OR=function(a,b,c){this.or=new GenericObjectCollection.Filter(a,b,c,this);this.xor=this.and=null;return this.or};GenericObjectCollection.Filter.prototype.AND=function(a,b,c){this.and=new GenericObjectCollection.Filter(a,b,c,this);this.xor=this.or=null;return this.and};
GenericObjectCollection.Filter.prototype.XOR=function(a,b,c){this.xor=new GenericObjectCollection.Filter(a,b,c,this);return this.or=this.and=null};GenericObjectCollection.Filter.prototype.toRoot=function(){for(var a=this;null!=a.parent;)a=a.parent;return a};
GenericObjectCollection.Filter.prototype.process=function(a){var b=!1,c=null,c=-1!=this.attribute.indexOf(".")?GenericObjectCollection.Query.deepSearch(this.attribute,a):a[this.attribute].get();switch(this.operator){case JSGO.OPERATOR.EQ:c==this.value&&(b=!0);break;case JSGO.OPERATOR.GTE:c>=this.value&&(b=!0);break;case JSGO.OPERATOR.MTE:c<=this.value&&(b=!0);break;case JSGO.OPERATOR.GT:c>this.value&&(b=!0);break;case JSGO.OPERATOR.MT:c<this.value&&(b=!0);break;case JSGO.OPERATOR.LIKE:"RegExp"==this.value.constructor.name&&
this.value.test(c)&&(b=!0);break;default:throw Error("Operator "+this.operator+" doesn't exists");}if(1<(null!=this.or)+(null!=this.and)+(null!=this.xor))throw Error("Filter using more than one logic conector.");return null!=this.or?b||this.or.process(a):null!=this.and?b&&this.and.process(a):null!=this.xor?(a=this.xor.process(a),b&&!a||!b&&a):b};
GenericObjectCollection.Query.prototype.Select=function(a){if(Array.isArray(a))this.query.selection=a;else{var b=arguments;this.query.selection=[];for(i in b)this.query.selection.push(b[i])}var c=this,b={};this.query.type=JSGO.METHOD.SELECT;b.From=this.fromFunc;this.selectedAttributes=function(a){var b={},e=c.query.selection;for(i in e){if("*"==e[i]){b=a.toObject();break}b[e[i]]="undefined"!=typeof e[i]?-1!=e[i].indexOf(".")?GenericObjectCollection.Query.deepSearch(e[i],a):a[e[i]].get():null}return b};
return b};Object.defineProperty(GenericObjectCollection.Query.prototype,"__whenOrderBy",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b,c){if("undefined"==typeof c||c!=JSGO.ORDER.ASC&&c!=JSGO.ORDER.DESC)throw Error("Unrecognized order type. Use JSGO.ORDER enum");a.sort(function(a,f){a=a[b];f=f[b];return c==JSGO.ORDER.ASC?a>f:a<f})}});
GenericObjectCollection.Query.prototype.Update=function(a){if(Array.isArray(a))this.query.selection=a;else{var b=arguments;this.query.selection=[];for(i in b)this.query.selection.push(b[i])}b={};this.query.type=JSGO.METHOD.UPDATE;b.From=this.fromFunc;return b};
Object.defineProperty(GenericObjectCollection.Query.prototype,"__whenUpdate",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){var c=!1;for(attr in a)try{if(-1!=a[attr].indexOf(".")){var d=a[attr].split("."),f=this.collection.objects[b],e=0;for(e;e<d.length-1;e++)f=f instanceof GenericObject?f[d[e]].get():f[d[e]];f instanceof GenericObject?f[d[e]].set(this.query.updateTo[attr]):f[d[e]]=this.query.updateTo[attr]}this.collection.objects[b][a[attr]].set(this.query.updateTo[attr]);c=!0}catch(k){var g=
this.query.updateTo[attr],e=collection.objects[b][a[attr]].info().type,h=this.collection.objects[b],g="On UPDATE: Attribute "+a[attr]+" doesn't accepts "+g+" as a valid value\n",g=g+("\tCollection index: "+b+"\n"),g=g+("\tAttribute type: "+e+"\n"),g=g+"\tObject:\n";console.warn(g,h)}return c}});GenericObjectCollection.Query.prototype.Delete=function(){this.query.selection=[];var a={};this.query.type=JSGO.METHOD.DELETE;a.From=this.fromFunc;return a};